<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Browser Assistant</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4361ee;
            --secondary-color: #3f37c9;
            --text-color: #333;
            --bg-color: #f8f9fa;
            --chat-bg: #ffffff;
            --user-bubble: #e3f2fd;
            --ai-bubble: #f1f1f1;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            --sidebar-width: 280px;
            --header-height: 60px;
            --input-height: 80px;
            --link-color: #000000;
        }

        [data-theme="dark"] {
            --primary-color: #4895ef;
            --secondary-color: #4361ee;
            --text-color: #f8f9fa;
            --bg-color: #121212;
            --chat-bg: #1e1e1e;
            --user-bubble: #2a3f5f;
            --ai-bubble: #333333;
            --shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            --link-color: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            touch-action: manipulation;
        }

        .app-container {
            display: flex;
            width: 100%;
            height: 100%;
            position: relative;
        }

        /* Sidebar Styles */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--chat-bg);
            padding: 15px;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            will-change: transform;
        }

        .sidebar.open {
            transform: translateX(0);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-top: 10px;
        }

        .sidebar h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .api-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 25px;
        }

        .api-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .setting-option {
            margin-bottom: 15px;
        }

        .setting-option label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .setting-option select, .setting-option input {
            width: 100%;
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background-color: var(--chat-bg);
            color: var(--text-color);
            font-size: 0.9rem;
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 99;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .sidebar-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .app-header {
            padding: 0 15px;
            height: var(--header-height);
            min-height: var(--header-height);
            background-color: var(--chat-bg);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
        }

        .app-header h1 {
            font-size: 1.2rem;
            color: var(--primary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 60%;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-size: 1rem;
            padding: 8px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            min-width: 40px;
            height: 40px;
        }

        .icon-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-color);
            height: calc(100% - var(--header-height));
            position: relative;
        }

        .chat-history {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
            padding-bottom: 20px;
        }

        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 18px;
            line-height: 1.4;
            position: relative;
            animation: fadeIn 0.3s ease-out;
            font-size: 0.95rem;
            word-wrap: break-word;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .user-message {
            align-self: flex-end;
            background-color: var(--user-bubble);
            color: var(--text-color);
            border-bottom-right-radius: 4px;
        }

        .ai-message {
            align-self: flex-start;
            background-color: var(--ai-bubble);
            color: var(--text-color);
            border-bottom-left-radius: 4px;
        }

        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--text-color);
            border-radius: 50%;
            display: inline-block;
            margin-right: 3px;
            animation: bounce 1.5s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }

        .input-area {
            padding: 10px 15px;
            background-color: var(--chat-bg);
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            min-height: var(--input-height);
        }

        .input-container {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
            align-items: center;
        }

        #user-input {
            flex: 1;
            padding: 10px 15px;
            border-radius: 25px;
            border: 1px solid #ddd;
            font-size: 0.95rem;
            background-color: var(--chat-bg);
            color: var(--text-color);
            outline: none;
            transition: border-color 0.3s;
            min-height: 45px;
            max-height: 120px;
            resize: none;
            line-height: 1.4;
        }

        #user-input:focus {
            border-color: var(--primary-color);
        }

        .disclaimer {
            font-size: 0.7rem;
            color: #777;
            text-align: center;
            line-height: 1.3;
        }

        /* Markdown-like styles for AI responses */
        .ai-message pre {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 8px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 8px 0;
            font-size: 0.85rem;
        }

        .ai-message code {
            font-family: monospace;
            background-color: rgba(0, 0, 0, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            font-size: 0.85rem;
        }

        .ai-message strong {
            font-weight: bold;
        }

        .ai-message em {
            font-style: italic;
        }

        .ai-message ul, .ai-message ol {
            margin-left: 18px;
            margin-bottom: 8px;
        }

        .ai-message li {
            margin-bottom: 4px;
        }

        /* Link styles */
        .ai-message a {
            color: #808080; /* Grey color */
            font-weight: bold;
            text-decoration: none;
        }

        /* Weather widget styles */
        .weather-widget {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .weather-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }
        .weather-icon {
            width: 50px;
            height: 50px;
        }
        .weather-temp {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .weather-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        .weather-detail {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9rem;
        }

        /* Responsive Styles */
        @media (min-width: 768px) {
            :root {
                --sidebar-width: 300px;
                --header-height: 70px;
            }

            .sidebar {
                position: relative;
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: none;
            }

            .app-header h1 {
                font-size: 1.3rem;
            }

            .message {
                max-width: 75%;
                padding: 12px 16px;
                font-size: 1rem;
            }

            #user-input {
                font-size: 1rem;
            }
        }

        @media (min-width: 992px) {
            :root {
                --sidebar-width: 320px;
            }

            .message {
                max-width: 70%;
            }
        }

        /* Very small devices (phones, 400px and down) */
        @media (max-width: 400px) {
            :root {
                --sidebar-width: 260px;
                --header-height: 55px;
            }

            .app-header h1 {
                font-size: 1.1rem;
                max-width: 50%;
            }

            .message {
                max-width: 90%;
                font-size: 0.9rem;
                padding: 8px 12px;
            }

            #user-input {
                font-size: 0.9rem;
                padding: 8px 12px;
            }
        }

        /* Tablet landscape */
        @media (min-width: 768px) and (orientation: landscape) {
            :root {
                --header-height: 60px;
                --input-height: 70px;
            }
        }

        /* Large desktop screens */
        @media (min-width: 1200px) {
            :root {
                --sidebar-width: 350px;
            }
        }

        /* Prevent zoom on input focus in mobile */
        @media (max-width: 768px) {
            input, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>Settings</h3>
            </div>
            
            <div class="api-selector">
                <h3>Knowledge Sources</h3>
                <div class="api-options">
                    <label><input type="checkbox" name="api" value="wikipedia" checked> Wikipedia</label>
                    <label><input type="checkbox" name="api" value="news" checked> News API</label>
                    <label><input type="checkbox" name="api" value="weather" checked> Weather API</label>
                    <label><input type="checkbox" name="api" value="maps" checked> Maps API</label>
                    <label><input type="checkbox" name="api" value="browser" checked> Browser Search</label>
                </div>
            </div>
            
            <div class="settings">
                <h3>Preferences</h3>
                <div class="setting-option">
                    <label for="theme">Theme:</label>
                    <select id="theme">
                        <option value="light">Light</option>
                        <option value="dark">Dark</option>
                        <option value="system">System</option>
                    </select>
                </div>
                <div class="setting-option">
                    <label for="voice-enabled">Voice Input:</label>
                    <select id="voice-enabled">
                        <option value="enabled">Enabled</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
            </div>
        </aside>

        <div class="sidebar-overlay" id="sidebar-overlay"></div>
        
        <div class="main-content">
            <header class="app-header">
                <h1>AI Browser Assistant</h1>
                <button id="new-chat-btn" class="icon-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </header>
            
            <div class="chat-container">
                <div class="chat-history" id="chat-history">
                    <!-- Messages will appear here -->
                </div>
                
                <div class="input-area">
                    <div class="input-container">
                        <textarea id="user-input" placeholder="Ask me anything..." rows="1"></textarea>
                        <button id="send-btn" class="icon-btn">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button id="voice-btn" class="icon-btn">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="disclaimer">
                        <p>This AI uses public APIs and browser capabilities to answer questions.It was under work, So type correct words or Ispaling.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const chatHistory = document.getElementById('chat-history');
            const userInput = document.getElementById('user-input');
            const sendBtn = document.getElementById('send-btn');
            const voiceBtn = document.getElementById('voice-btn');
            const newChatBtn = document.getElementById('new-chat-btn');
            const themeSelect = document.getElementById('theme');
            const voiceSelect = document.getElementById('voice-enabled');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            
            // State
            let currentChat = [];
            let recognition = null;
            let isSidebarOpen = false;
            
            // API Keys 
            const API_KEYS = {
                NEWS: 'pub_976ec11944b142b7ad92f49c39c8d083', // NewsData.io API key (free tier)
                WEATHER: '7aeb3684231dace95f847e71f9b474b0' // OpenWeatherMap API key
            };
            
            // Initialize the app
            function init() {
                loadThemePreference();
                loadChatHistory();
                setupEventListeners();
                checkSystemTheme();
                setupTextareaResize();
                
                // Add welcome message if it's a new chat
                if (currentChat.length === 0) {
                    addAIMessage("Hello! I'm Callanix, your AI assistant. I can answer questions using various APIs including Wikipedia, News, Weather, Maps, and web search. What would you like to know?");
                }
            }
            
            // Set up auto-resizing textarea
            function setupTextareaResize() {
                userInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = (this.scrollHeight) + 'px';
                    
                    // Limit maximum height
                    if (this.scrollHeight > 120) {
                        this.style.overflowY = 'auto';
                    } else {
                        this.style.overflowY = 'hidden';
                    }
                });
                
                // Trigger input event to set initial height
                userInput.dispatchEvent(new Event('input'));
            }
            
            // Set up event listeners
            function setupEventListeners() {
                // Send message on button click or Enter key (without shift)
                sendBtn.addEventListener('click', sendMessage);
                userInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                // Voice input
                voiceBtn.addEventListener('click', toggleVoiceInput);
                
                // New chat
                newChatBtn.addEventListener('click', startNewChat);
                
                // Theme selection
                themeSelect.addEventListener('change', changeTheme);
                
                // Check for browser speech recognition support
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    voiceBtn.disabled = true;
                    voiceBtn.title = "Voice input not supported in your browser";
                }
                
                // Handle orientation changes
                window.addEventListener('orientationchange', handleResize);
                window.addEventListener('resize', handleResize);
            }
            
            // Toggle sidebar
            function toggleSidebar() {
                isSidebarOpen = !isSidebarOpen;
                if (isSidebarOpen) {
                    sidebar.classList.add('open');
                    sidebarOverlay.classList.add('open');
                    document.body.style.overflow = 'hidden';
                } else {
                    sidebar.classList.remove('open');
                    sidebarOverlay.classList.remove('open');
                    document.body.style.overflow = '';
                }
            }
            
            // Handle resize and orientation changes
            function handleResize() {
                // Close sidebar if open when switching to larger viewport
                if (window.innerWidth >= 768 && isSidebarOpen) {
                    toggleSidebar();
                }
                
                // Adjust chat history height
                scrollToBottom();
            }
            
            // Load theme preference from localStorage
            function loadThemePreference() {
                const savedTheme = localStorage.getItem('theme') || 'system';
                themeSelect.value = savedTheme;
                applyTheme(savedTheme);
            }
            
            // Check system theme preference
            function checkSystemTheme() {
                if (themeSelect.value === 'system') {
                    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
                }
                
                // Listen for system theme changes
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                    if (themeSelect.value === 'system') {
                        document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
                    }
                });
            }
            
            // Change theme
            function changeTheme() {
                const theme = themeSelect.value;
                localStorage.setItem('theme', theme);
                applyTheme(theme);
            }
            
            // Apply selected theme
            function applyTheme(theme) {
                if (theme === 'system') {
                    checkSystemTheme();
                } else {
                    document.documentElement.setAttribute('data-theme', theme);
                }
            }
            
            // Load chat history from localStorage
            function loadChatHistory() {
                const savedChat = localStorage.getItem('currentChat');
                if (savedChat) {
                    currentChat = JSON.parse(savedChat);
                    renderChatHistory();
                }
            }
            
            // Save chat to localStorage
            function saveChat() {
                localStorage.setItem('currentChat', JSON.stringify(currentChat));
            }
            
            // Render chat history
            function renderChatHistory() {
                chatHistory.innerHTML = '';
                currentChat.forEach(message => {
                    if (message.role === 'user') {
                        addUserMessage(message.content, false);
                    } else {
                        addAIMessage(message.content, false);
                    }
                });
                scrollToBottom();
            }
            
            // Start a new chat
            function startNewChat() {
                currentChat = [];
                chatHistory.innerHTML = '';
                saveChat();
                addAIMessage("Hello! I'm Callanix, your AI assistant. What would you like to know?");
            }
            
            // Add user message to chat
            function addUserMessage(message, save = true) {
                const messageElement = document.createElement('div');
                messageElement.className = 'message user-message';
                messageElement.textContent = message;
                chatHistory.appendChild(messageElement);
                
                if (save) {
                    currentChat.push({ role: 'user', content: message });
                    saveChat();
                }
                
                scrollToBottom();
            }
            
            // Add AI message to chat
            function addAIMessage(message, save = true) {
                // If there's already a typing indicator, remove it first
                const existingTyping = document.querySelector('.typing-indicator');
                if (existingTyping) {
                    existingTyping.remove();
                }
                
                const messageElement = document.createElement('div');
                messageElement.className = 'message ai-message';
                
                // Simple markdown parsing for bold, italics, and code
                let formattedMessage = message
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code>$1</code>');
                
                // Handle code blocks
                formattedMessage = formattedMessage.replace(/```([a-z]*)\n([\s\S]*?)\n```/g, 
                    '<pre><code class="language-$1">$2</code></pre>');
                
                // Handle line breaks
                formattedMessage = formattedMessage.replace(/\n/g, '<br>');
                
                // Handle links
                formattedMessage = formattedMessage.replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>');
                
                messageElement.innerHTML = formattedMessage;
                chatHistory.appendChild(messageElement);
                
                if (save) {
                    currentChat.push({ role: 'ai', content: message });
                    saveChat();
                }
                
                scrollToBottom();
            }
            
            // Show typing indicator
            function showTypingIndicator() {
                const typingElement = document.createElement('div');
                typingElement.className = 'message ai-message typing-indicator';
                typingElement.innerHTML = '<span></span><span></span><span></span>';
                chatHistory.appendChild(typingElement);
                scrollToBottom();
            }
            
            // Remove typing indicator
            function removeTypingIndicator() {
                const typingElement = document.querySelector('.typing-indicator');
                if (typingElement) {
                    typingElement.remove();
                }
            }
            
            // Scroll to bottom of chat
            function scrollToBottom() {
                // Small timeout to ensure DOM updates are complete
                setTimeout(() => {
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }, 50);
            }
            
            // Send message to AI
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                addUserMessage(message);
                userInput.value = '';
                // Reset textarea height
                userInput.style.height = 'auto';
                
                showTypingIndicator();
                
                try {
                    const response = await processQuery(message);
                    removeTypingIndicator();
                    addAIMessage(response);
                } catch (error) {
                    removeTypingIndicator();
                    addAIMessage("Sorry, I encountered an error processing your request. Please try again.");
                    console.error("Error:", error);
                }
            }
            
            // Handle general conversational questions
            function handleGeneralQuestions(query) {
                const lowerQuery = query.toLowerCase().trim();
                
                // Greetings
                if (/^(hi|hello|hey|greetings|good morning|good afternoon|good evening)/i.test(lowerQuery)) {
                    const greetings = [
                        "Hello! I'm Callanix, your AI assistant. How can I help you today?",
                        "Hi there! Callanix here, ready to assist you.",
                        "Greetings! I'm Callanix, your AI helper. What can I do for you?"
                    ];
                    return greetings[Math.floor(Math.random() * greetings.length)];
                }
                
                // Name questions
                if (/what('s| is) your name/i.test(lowerQuery) || /who are you/i.test(lowerQuery)) {
                    return "My name is Callanix. I'm your AI-powered browser assistant!";
                }
                
                // Creator questions
                if (/who (created|made|developed) you/i.test(lowerQuery)) {
                    return "I was created by a team of developers to help you with information and tasks through your browser.";
                }
                
                // Capabilities
                if (/what can you do/i.test(lowerQuery) || /your abilities/i.test(lowerQuery)) {
                    return "I can answer questions using various sources like Wikipedia, news, weather data, and web search. I can also help with general knowledge, definitions, and recommendations. Try asking me anything!";
                }
                
                // How are you
                if (/how are you/i.test(lowerQuery)) {
                    const responses = [
                        "I'm just a program, so I don't have feelings, but I'm functioning perfectly and ready to help you!",
                        "As an AI, I don't experience emotions, but I'm operating at full capacity to assist you!",
                        "I'm always doing well when I can help users like you!"
                    ];
                    return responses[Math.floor(Math.random() * responses.length)];
                }
                
                // Time questions
                if (/what(?:'s| is) the time/i.test(lowerQuery) || /current time/i.test(lowerQuery)) {
                    const now = new Date();
                    return `The current time is ${now.toLocaleTimeString()}.`;
                }
                
                // Date questions
                if (/what(?:'s| is) the date/i.test(lowerQuery) || /today'?s date/i.test(lowerQuery)) {
                    const now = new Date();
                    return `Today's date is ${now.toLocaleDateString()}.`;
                }
                
                // Thank you responses
                if (/thank you|thanks|thank's|thanku/i.test(lowerQuery)) {
                    const thanksResponses = [
                        "You're welcome! Is there anything else I can help you with?",
                        "Happy to help! Let me know if you need anything else.",
                        "My pleasure! Don't hesitate to ask if you have more questions."
                    ];
                    return thanksResponses[Math.floor(Math.random() * thanksResponses.length)];
                }
                
                // Goodbye responses
                if (/bye|goodbye|see you|farewell/i.test(lowerQuery)) {
                    const goodbyeResponses = [
                        "Goodbye! Feel free to come back if you have more questions.",
                        "See you later! I'll be here if you need me.",
                        "Farewell! Don't hesitate to return if you need assistance."
                    ];
                    return goodbyeResponses[Math.floor(Math.random() * goodbyeResponses.length)];
                }

                // Help requests
                if (/help/i.test(lowerQuery)) {
                    return "I can help with:\n- General knowledge questions\n- Current news\n- Weather forecasts\n- Location information\n- Web searches\n\nTry asking me something like:\n- 'What is the capital of France?'\n- 'Tell me about quantum computing'\n- 'News about technology'\n- 'Weather in New York'";
                }
                
                // Compliments
                if (/you('re| are) (awesome|great|amazing|smart|intelligent)/i.test(lowerQuery)) {
                    return "Thank you! I'm designed to be helpful. How can I assist you further?";
                }
                
                // Jokes
                if (/tell me a joke/i.test(lowerQuery)) {
                    const jokes = [
                        "Why don't scientists trust atoms? Because they make up everything!",
                        "Why did the scarecrow win an award? Because he was outstanding in his field!",
                        "What do you call fake spaghetti? An impasta!"
                    ];
                    return jokes[Math.floor(Math.random() * jokes.length)];
                }
                
                // Fun facts
                if (/tell me a fun fact/i.test(lowerQuery)) {
                    const facts = [
                        "Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old and still perfectly good to eat!",
                        "The shortest war in history was between Britain and Zanzibar on August 27, 1896. Zanzibar surrendered after 38 minutes.",
                        "A group of flamingos is called a 'flamboyance'."
                    ];
                    return facts[Math.floor(Math.random() * facts.length)];
                }
                
                // Age questions
                if (/how old are you/i.test(lowerQuery)) {
                    return "As an AI, I don't have an age in the traditional sense. I was created recently and continuously updated!";
                }
                
                // Location questions
                if (/where are you/i.test(lowerQuery)) {
                    return "I exist in the digital realm, running on servers and available wherever you need me through this browser!";
                }
                
                // Purpose questions
                if (/what('s| is) your purpose/i.test(lowerQuery)) {
                    return "My purpose is to assist you by providing information, answering questions, and helping with tasks through your browser.";
                }
                
                // Favorite questions
                if (/what('s| is) your (favorite|favourite) (color|colour|food|movie|book)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/what('s| is) your (favorite|favourite) (.*)/i);
                    if (match) {
                        const thing = match[3];
                        return `As an AI, I don't have personal preferences for ${thing}, but I can help you find popular options!`;
                    }
                }
                
                // Meaning of life
                if (/meaning of life/i.test(lowerQuery)) {
                    return "The answer to the ultimate question of life, the universe, and everything is... 42. (According to Douglas Adams' 'The Hitchhiker's Guide to the Galaxy')";
                }
                
                // Love questions
                if (/do you (love|like) me/i.test(lowerQuery)) {
                    return "I'm designed to be helpful and supportive to all users! While I don't experience emotions, I'm always happy to assist you.";
                }
                
                // Weather questions
                if (/how('s| is) the weather/i.test(lowerQuery)) {
                    return "I can check the weather for you if you tell me a location (e.g., 'The weather in New York').";
                }

                // News questions
                if (/what('s| is) (new|happening)/i.test(lowerQuery)) {
                    return "I can fetch the latest news for you. Try asking something like 'news about technology' or 'current events'.";
                }
                
                // Who is questions
                if (/who (is|was) (.+)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/who (is|was) (.+)/i);
                    if (match) {
                        const person = match[2];
                        return `I can look up information about ${person}. Would you like me to search for ${person}?`;
                    }
                }
                
                // What is questions
                if (/what('s| is) (.+)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/what('s| is) (.+)/i);
                    if (match) {
                        const thing = match[2];
                        return `I can look up information about ${thing}. Would you like me to search for it? "Then type ${thing}".`;
                    }
                }
                
                // How to questions
                if (/how to (.+)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/how to (.+)/i);
                    if (match) {
                        const task = match[1];
                        return `I can help with instructions for ${task}. Would you like me to search for guides?`;
                    }
                }
                
                // Definition questions
                if (/what does (.+) mean/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/what does (.+) mean/i);
                    if (match) {
                        const word = match[1];
                        return `I can look up the definition of ${word}. Would you like me to search for it?`;
                    }
                }
                
                // Calculation questions
                if (/calculate|what is (\d+ [\+\-\*\/] \d+)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/(\d+)\s*([\+\-\*\/])\s*(\d+)/i);
                    if (match) {
                        const num1 = parseFloat(match[1]);
                        const operator = match[2];
                        const num2 = parseFloat(match[3]);
                        
                        let result;
                        switch(operator) {
                            case '+': result = num1 + num2; break;
                            case '-': result = num1 - num2; break;
                            case '*': result = num1 * num2; break;
                            case '/': result = num1 / num2; break;
                            default: return "I can perform basic calculations. Try asking something like 'What is 5 + 7?'";
                        }
                        
                        return `The result of ${num1} ${operator} ${num2} is ${result}.`;
                    }
                    return "I can perform basic calculations. Try asking something like 'What is 5 + 7?'";
                }
                
                // Conversion questions
                if (/convert (\d+) (.+) to (.+)/i.test(lowerQuery)) {
                    const match = lowerQuery.match(/convert (\d+) (.+) to (.+)/i);
                    if (match) {
                        const value = parseFloat(match[1]);
                        const fromUnit = match[2].toLowerCase();
                        const toUnit = match[3].toLowerCase();
                        
                        // Temperature conversions
                        if (fromUnit.includes('celsius') && toUnit.includes('fahrenheit')) {
                            const converted = (value * 9/5) + 32;
                            return `${value}째C is ${converted.toFixed(1)}째F`;
                        }
                        if (fromUnit.includes('fahrenheit') && toUnit.includes('celsius')) {
                            const converted = (value - 32) * 5/9;
                            return `${value}째F is ${converted.toFixed(1)}째C`;
                        }
                        
                        // Length conversions
                        const lengthConversions = {
                            'meter': 1,
                            'meters': 1,
                            'm': 1,
                            'kilometer': 1000,
                            'kilometers': 1000,
                            'km': 1000,
                            'centimeter': 0.01,
                            'centimeters': 0.01,
                            'cm': 0.01,
                            'millimeter': 0.001,
                            'millimeters': 0.001,
                            'mm': 0.001,
                            'mile': 1609.34,
                            'miles': 1609.34,
                            'yard': 0.9144,
                            'yards': 0.9144,
                            'foot': 0.3048,
                            'feet': 0.3048,
                            'ft': 0.3048,
                            'inch': 0.0254,
                            'inches': 0.0254,
                            'in': 0.0254
                        };
                        
                        if (lengthConversions[fromUnit] && lengthConversions[toUnit]) {
                            const meters = value * lengthConversions[fromUnit];
                            const converted = meters / lengthConversions[toUnit];
                            return `${value} ${fromUnit} is ${converted.toFixed(2)} ${toUnit}`;
                        }
                        
                        // Weight conversions
                        const weightConversions = {
                            'kilogram': 1,
                            'kilograms': 1,
                            'kg': 1,
                            'gram': 0.001,
                            'grams': 0.001,
                            'g': 0.001,
                            'milligram': 0.000001,
                            'milligrams': 0.000001,
                            'mg': 0.000001,
                            'pound': 0.453592,
                            'pounds': 0.453592,
                            'lb': 0.453592,
                            'ounce': 0.0283495,
                            'ounces': 0.0283495,
                            'oz': 0.0283495
                        };
                        
                        if (weightConversions[fromUnit] && weightConversions[toUnit]) {
                            const kg = value * weightConversions[fromUnit];
                            const converted = kg / weightConversions[toUnit];
                            return `${value} ${fromUnit} is ${converted.toFixed(2)} ${toUnit}`;
                        }
                        
                        return `I can't convert ${fromUnit} to ${toUnit} yet. I support temperature, length, and weight conversions.`;
                    }
                    return "I can help with unit conversions. Try asking something like 'convert 10 meters to feet' or 'convert 32 fahrenheit to celsius'.";
                }
                
                // Default response if no general question matched
                return null;
            }
            
            // Process user query
            async function processQuery(query) {
                // First check if it's a general question
                const generalResponse = handleGeneralQuestions(query);
                if (generalResponse) {
                    return generalResponse;
                }
                
                const selectedApis = Array.from(document.querySelectorAll('input[name="api"]:checked'))
                                        .map(api => api.value);
                
                // Check if query is about current location
                if (query.toLowerCase().includes('near me') || 
                    query.toLowerCase().includes('around here')) {
                    if (selectedApis.includes('browser') || selectedApis.includes('maps') || selectedApis.includes('weather')) {
                        try {
                            const location = await getLocation();
                            if (location) {
                                query = query + ` (latitude: ${location.lat}, longitude: ${location.lon})`;
                            }
                        } catch (error) {
                            console.error("Geolocation error:", error);
                        }
                    }
                }
                
                // Try different APIs based on query
                let response = '';
                
                if (selectedApis.includes('wikipedia') && isGeneralKnowledge(query)) {
                    response = await fetchWikipediaData(query);
                } 
                
                if (!response && selectedApis.includes('news') && isNewsQuery(query)) {
                    response = await fetchNewsData(query);
                }
                
                if (!response && selectedApis.includes('weather') && isWeatherQuery(query)) {
                    response = await fetchWeatherData(query);
                }
                
                if (!response && selectedApis.includes('maps') && isMapsQuery(query)) {
                    response = await fetchMapsData(query);
                }
                
                if (!response && selectedApis.includes('browser')) {
                    response = await fetchWebSearch(query);
                }
                
                return response || "I couldn't find an answer to that question with the currently selected knowledge sources.";
            }
            
            // Determine if query is general knowledge
            function isGeneralKnowledge(query) {
                const generalTerms = ['what is', 'who is', 'define', 'explain', 'tell me about'];
                return generalTerms.some(term => query.toLowerCase().includes(term));
            }
            
            // Determine if query is news-related
            function isNewsQuery(query) {
                const newsTerms = ['news', 'headlines', 'current events', 'recent', 'latest'];
                return newsTerms.some(term => query.toLowerCase().includes(term));
            }
            
            // Determine if query is weather-related
            function isWeatherQuery(query) {
                const weatherTerms = ['weather', 'temperature', 'forecast', 'rain', 'sunny', 'humid', 'wind'];
                return weatherTerms.some(term => query.toLowerCase().includes(term));
            }
            
            // Determine if query is maps-related
            function isMapsQuery(query) {
                const mapsTerms = ['map', 'location', 'nearby', 'directions', 'distance', 'restaurants', 'hotels', 'places'];
                return mapsTerms.some(term => query.toLowerCase().includes(term));
            }
            
            // API Functions
            
            // Wikipedia API
            async function fetchWikipediaData(query) {
                try {
                    // Clean the query for Wikipedia API
                    const cleanQuery = query.replace(/\b(what is|who is|define|explain|tell me about)\b/gi, '').trim();
                    const response = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(cleanQuery)}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            return null; // No Wikipedia page found
                        }
                        throw new Error(`Wikipedia API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.extract) {
                        return `According to Wikipedia: ${data.extract}\n\n[Read more on Wikipedia](${data.content_urls.desktop.page})`;
                    } else if (data.description) {
                        return `Wikipedia has information about ${cleanQuery}: ${data.description}\n\n[Read more on Wikipedia](${data.content_urls.desktop.page})`;
                    }
                    
                    return null;
                } catch (error) {
                    console.error('Wikipedia API error:', error);
                    return null;
                }
            }
            
            // News API (using NewsData.io)
            async function fetchNewsData(query) {
                try {
                    // Clean the query for news search
                    const cleanQuery = query.replace(/\b(news|headlines|about)\b/gi, '').trim();
                    const response = await fetch(`https://newsdata.io/api/1/news?apikey=${API_KEYS.NEWS}&q=${encodeURIComponent(cleanQuery)}&language=en`);
                    
                    if (!response.ok) {
                        throw new Error(`News API error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.results && data.results.length > 0) {
                        let newsItems = data.results.slice(0, 3); // Get top 3 news items
                        let newsResponse = "Here are some recent news articles:\n\n";
                        
                        newsItems.forEach((item, index) => {
                            newsResponse += `${index + 1}. [${item.title}](${item.link})`;
                            if (item.description) {
                                newsResponse += ` - ${item.description}`;
                            }
                            newsResponse += "\n\n";
                        });
                        
                        return newsResponse;
                    }
                    
                    return "I couldn't find any recent news about that topic.";
                } catch (error) {
                    console.error('News API error:', error);
                    return "Sorry, I couldn't fetch news at the moment. Please try again later.";
                }
            }
            
            // Weather API (using OpenWeatherMap)
            async function fetchWeatherData(query) {
                try {
                    let location = null;
                    let locationName = "";
                    
                    // Check for "near me" queries
                    if (query.toLowerCase().includes('near me') || query.toLowerCase().includes('here')) {
                        location = await getLocation();
                        if (location) {
                            // Get location name using reverse geocoding
                            const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${location.lat}&lon=${location.lon}&limit=1&appid=${API_KEYS.WEATHER}`);
                            const geoData = await geoResponse.json();
                            if (geoData && geoData.length > 0) {
                                locationName = geoData[0].name + ", " + geoData[0].country;
                            }
                        }
                    } else {
                        // Extract location from query
                        const locationMatch = query.match(/in (.+)/i);
                        if (locationMatch) {
                            locationName = locationMatch[1];
                            // Get coordinates from location name
                            const geoResponse = await fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${encodeURIComponent(locationName)}&limit=1&appid=${API_KEYS.WEATHER}`);
                            const geoData = await geoResponse.json();
                            if (geoData && geoData.length > 0) {
                                location = {
                                    lat: geoData[0].lat,
                                    lon: geoData[0].lon
                                };
                                locationName = geoData[0].name + ", " + geoData[0].country;
                            }
                        }
                    }
                    
                    if (!location) {
                        return "Please specify a location for weather information (e.g., 'weather in New York').";
                    }
                    
                    // Get weather data with the working API key
                    const weatherResponse = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${location.lat}&lon=${location.lon}&appid=${API_KEYS.WEATHER}&units=metric`);
                    const weatherData = await weatherResponse.json();
                    
                    if (weatherData.weather && weatherData.main) {
                        const weatherDesc = weatherData.weather[0].description;
                        const temp = weatherData.main.temp;
                        const feelsLike = weatherData.main.feels_like;
                        const humidity = weatherData.main.humidity;
                        const windSpeed = weatherData.wind.speed;
                        const iconCode = weatherData.weather[0].icon;
                        const iconUrl = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
                        
                        return `
                        <div class="weather-widget">
                            <strong>Current weather ${locationName ? "in " + locationName : "at your location"}:</strong>
                            <div class="weather-header">
                                <img src="${iconUrl}" alt="${weatherDesc}" class="weather-icon">
                                <span class="weather-temp">${temp}째C</span>
                            </div>
                            <div class="weather-details">
                                <div class="weather-detail">
                                    <i class="fas fa-temperature-low"></i>
                                    <span>Feels like: ${feelsLike}째C</span>
                                </div>
                                <div class="weather-detail">
                                    <i class="fas fa-tint"></i>
                                    <span>Humidity: ${humidity}%</span>
                                </div>
                                <div class="weather-detail">
                                    <i class="fas fa-wind"></i>
                                    <span>Wind: ${windSpeed} m/s</span>
                                </div>
                                <div class="weather-detail">
                                    <i class="fas fa-cloud"></i>
                                    <span>${weatherDesc}</span>
                                </div>
                            </div>
                            <small><a href="https://openweathermap.org/city/${weatherData.id}" target="_blank">More details</a></small>
                        </div>
                        `;
                    }
                    
                    return "I couldn't retrieve weather information for that location.";
                } catch (error) {
                    console.error('Weather API error:', error);
                    return "Sorry, I couldn't fetch weather information at the moment. Please try again later.";
                }
            }
            
            // Maps API (using OpenStreetMap Nominatim)
            async function fetchMapsData(query) {
                try {
                    let location = null;
                    let locationName = "";
                    
                    // Check for "near me" queries
                    if (query.toLowerCase().includes('near me') || query.toLowerCase().includes('around here')) {
                        location = await getLocation();
                        if (location) {
                            // Get location name using reverse geocoding
                            const geoResponse = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${location.lat}&lon=${location.lon}`);
                            const geoData = await geoResponse.json();
                            if (geoData.address) {
                                locationName = geoData.address.city || geoData.address.town || geoData.address.village || "your location";
                            }
                        }
                    } else {
                        // Extract location from query
                        const locationMatch = query.match(/(?:near|in|at) (.+)/i);
                        if (locationMatch) {
                            locationName = locationMatch[1];
                        }
                    }
                    
                    if (!locationName) {
                        return "Please specify a location (e.g., 'restaurants in Paris').";
                    }
                    
                    // Determine what to search for
                    let searchTerm = "";
                    if (query.toLowerCase().includes('restaurant')) {
                        searchTerm = "restaurant";
                    } else if (query.toLowerCase().includes('hotel')) {
                        searchTerm = "hotel";
                    } else if (query.toLowerCase().includes('attraction') || query.toLowerCase().includes('place to visit')) {
                        searchTerm = "tourist attraction";
                    } else {
                        searchTerm = "point of interest";
                    }
                    
                    // Get coordinates for the location if we don't have them
                    if (!location) {
                        const geoResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(locationName)}&limit=1`);
                        const geoData = await geoResponse.json();
                        if (geoData && geoData.length > 0) {
                            location = {
                                lat: geoData[0].lat,
                                lon: geoData[0].lon
                            };
                        }
                    }
                    
                    if (location) {
                        // Search for places nearby
                        const placesResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm)}&near=${encodeURIComponent(locationName)}&limit=3`);
                        const placesData = await placesResponse.json();
                        
                        if (placesData && placesData.length > 0) {
                            let result = `Here are some ${searchTerm}s ${locationName ? "in " + locationName : "near you"}:\n\n`;
                            
                            placesData.forEach((place, index) => {
                                result += `${index + 1}. ${place.display_name}\n`;
                                result += `[View on map](https://www.openstreetmap.org/?mlat=${place.lat}&mlon=${place.lon}#map=16/${place.lat}/${place.lon})\n\n`;
                            });
                            
                            return result;
                        }
                    }
                    
                    return `I couldn't find any ${searchTerm}s ${locationName ? "in " + locationName : "near you"}.`;
                } catch (error) {
                    console.error('Maps API error:', error);
                    return "Sorry, I couldn't fetch location information at the moment. Please try again later.";
                }
            }
            
            // Web Search (using DuckDuckGo API)
            async function fetchWebSearch(query) {
                try {
                    const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                    const data = await response.json();
                    
                    if (data.AbstractText) {
                        return `Web search results: ${data.AbstractText}\n\n[More info](${data.AbstractURL})`;
                    } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
                        let result = "Web search results:\n\n";
                        const topics = data.RelatedTopics.slice(0, 3); // Get top 3 results
                        
                        topics.forEach((topic, index) => {
                            if (topic.Text && topic.FirstURL) {
                                result += `${index + 1}. [${topic.Text}](${topic.FirstURL})\n\n`;
                            }
                        });
                        
                        return result;
                    }
                    
                    return "I couldn't find any relevant web search results for that query.";
                } catch (error) {
                    console.error('Web search error:', error);
                    return "Sorry, I couldn't perform a web search at the moment. Please try again later.";
                }
            }
            
            // Get user's location
            function getLocation() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject('Geolocation not supported');
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        position => resolve({
                            lat: position.coords.latitude.toFixed(4),
                            lon: position.coords.longitude.toFixed(4)
                        }),
                        error => {
                            let errorMessage;
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage = "Location access was denied.";
                                    break;
                                case error.POSITION_UNAVAILABLE:
                                    errorMessage = "Location information is unavailable.";
                                    break;
                                case error.TIMEOUT:
                                    errorMessage = "The request to get location timed out.";
                                    break;
                                default:
                                    errorMessage = "An unknown error occurred.";
                            }
                            reject(errorMessage);
                        },
                        { timeout: 10000 }
                    );
                });
            }
            
            // Voice input functionality
            function toggleVoiceInput() {
                if (recognition && recognition.isListening) {
                    stopVoiceRecognition();
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                    voiceBtn.title = "Start voice input";
                } else {
                    startVoiceRecognition();
                    voiceBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    voiceBtn.title = "Stop voice input";
                }
            }
            
            function startVoiceRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = () => {
                    console.log("Voice recognition started");
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    userInput.value = transcript;
                    // Trigger input event to resize textarea
                    userInput.dispatchEvent(new Event('input'));
                };
                
                recognition.onerror = (event) => {
                    console.error("Voice recognition error:", event.error);
                    addAIMessage("Sorry, I couldn't understand your voice input. Please try typing instead.");
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                
                recognition.onend = () => {
                    voiceBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                };
                
                recognition.start();
            }
            
            function stopVoiceRecognition() {
                if (recognition) {
                    recognition.stop();
                }
            }
            
            // Initialize the app
            init();
        });
    </script>
</body>
</html>